FROM ubuntu:jammy
ENV DEBIAN_FRONTEND=noninteractive

RUN sed -i 's:^path-exclude=/usr/share/man:#path-exclude=/usr/share/man:' \
        /etc/dpkg/dpkg.cfg.d/excludes

RUN apt-get update && \
    apt-get -y install \
    zip \
    curl \
    python3-pip \
    python3 \
    openssh-server \
    ncat \
    net-tools \
    nano \
    sudo \
    socat \
    vim

RUN apt-get -y autoremove && \
    apt-get -y clean

ARG USERNAME=darel
ARG PASSWORD=g0d_d4mn_unbreakable_p455word
ARG USER_UID=1000
ARG USER_GID=$USER_UID
ARG user_flag=tqlCTF{1nQu1s1t1on_l34ds_to
ARG root_flag=_w0rld5_d3s7Ruc710n}

ARG APPUSER=app
ARG APPPASSWORD=g0d_d4mn_unbru7ab1e_p455word
ARG APP_UID=1001
ARG APP_GID=1001

RUN groupadd --gid $APP_GID $APPUSER \
    && useradd --uid $APP_UID --gid $APP_GID -m $APPUSER  \
    && echo "$APPUSER:$APPPASSWORD" | chpasswd


RUN groupadd --gid $USER_GID $USERNAME \
    && useradd --uid $USER_UID --gid $USER_GID -m $USERNAME -s /bin/rbash \
    && echo "$USERNAME:$PASSWORD" | chpasswd \
    && echo "export PATH=/home/$USERNAME/usr/bin" >> /home/$USERNAME/.bashrc \
    && mkdir -p /home/$USERNAME/usr/bin \
    && chmod -R 750 /home/$USERNAME/usr/bin \
    && chown -R root.$USERNAME /home/$USERNAME/.bash* /home/$USERNAME/.profile /home/$USERNAME \
    && chmod 640 /home/$USERNAME/.bash* /home/$USERNAME/.profile \
    && cd /home/$USERNAME \
    && touch .bashrc \
    && for i in .bash_login .bash_profile .bash_logout .profile; do echo ". .bashrc" > $i; done \
    && cp /bin/vim /home/$USERNAME/usr/bin/vim \
    && cp /bin/id /home/$USERNAME/usr/bin/id

RUN chmod 555 /home/$USERNAME/ -R && \
    echo "$user_flag" > /home/$USERNAME/user.txt && \
    echo "$root_flag" > /root/root.txt && \
    chown $USERNAME /home/$USERNAME/user.txt && \
    mkdir /home/$USERNAME/.ssh && \
    chmod 700 /home/$USERNAME/.ssh && \
    chown $USERNAME:$USERNAME /home/$USERNAME/.ssh && \
    chown root:root /root/root.txt && \
    chmod 400 /home/$USERNAME/user.txt && \
    chmod 400 /root/root.txt && \
    chown $USERNAME:$USERNAME /home/$USERNAME/* -R && \
    chown $USERNAME:$USERNAME /tmp && \
    chown $USERNAME:root /bin/find && chmod +s /bin/find && \
    chmod 700 /tmp && \
    pip3 install flask && \
    pip3 install requests && \
    pip3 install psutil

COPY ./app /home/app
COPY ./entrypoint.sh /opt/entrypoint.sh
COPY ./root.py /root/root.py

RUN chmod 755 /opt/entrypoint.sh && \
    chmod 755 /home/app/app.py && \
    chown $APPUSER:$APPUSER /home/app -R; \
    mkdir /var/run/sshd; \
    chmod 0755 /var/run/sshd

EXPOSE 10000
EXPOSE 22
USER root
ENTRYPOINT ["/bin/bash", "-c", "/opt/entrypoint.sh"]