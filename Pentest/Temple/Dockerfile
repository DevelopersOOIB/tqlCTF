FROM ubuntu:jammy
ENV DEBIAN_FRONTEND=noninteractive

RUN sed -i 's:^path-exclude=/usr/share/man:#path-exclude=/usr/share/man:' \
        /etc/dpkg/dpkg.cfg.d/excludes

RUN apt-get update && \
    apt-get -y install \
	zip \
	curl \
	python3-pip \
    python3 \
	openssh-server \
	ncat \
	net-tools \
    cron \
    nano\
	sudo 

RUN apt-get -y autoremove && \
    apt-get -y clean

ARG USERNAME=quentin
ARG PASSWORD=w3lc0m3_to_th3_T3mPL3!
ARG USER_UID=1000
ARG USER_GID=$USER_UID
ARG user_flag=tqlCTF{4_h1dd3n_t3mpL3
ARG root_flag=_h1d3s_d4ng3r0us_s3cr3ts}

ARG APPUSER=app
ARG APPPASSWORD=th3s3_4r3_t3mpl3s
ARG APP_UID=1001
ARG APP_GID=1001

RUN groupadd --gid $APP_GID $APPUSER \
    && useradd --uid $APP_UID --gid $APP_GID -m $APPUSER \
    && echo "$APPUSER:$APPPASSWORD" | chpasswd

RUN groupadd --gid $USER_GID $USERNAME \
    && useradd --uid $USER_UID --gid $USER_GID -m $USERNAME \
    && echo "$USERNAME:$PASSWORD" | chpasswd

RUN chmod 555 /home/$USERNAME/ -R && \
    echo "$user_flag" > /home/$USERNAME/user.txt && \
    echo "$root_flag" > /root/root.txt && \
    chown $USERNAME /home/$USERNAME/user.txt && \
    chown root:root /root/root.txt && \
    chmod 400 /home/$USERNAME/user.txt && \
    chmod 400 /root/root.txt && \
    chown $USERNAME:$USERNAME /home/$USERNAME/* -R && \
    pip3 install flask && \
    mkdir /backups && chmod +w backups

COPY ./notes.txt /home/$USERNAME/notes.txt
COPY ./notes /home/$USERNAME/notes 
COPY backup.sh /etc/cron.d/backup
COPY backup.sh /opt/backup.sh
COPY ./entrypoint.sh /opt/entrypoint.sh
COPY ./app /app
COPY ./run_app.sh /opt/run_app.sh

RUN chmod 755 /opt/entrypoint.sh && \
    chmod 744 /opt/backup.sh && \
    chmod 755 /app/app.py && \
    chown $APPUSER:$APPUSER /app -R && \
    chmod 777 /app && \
    chmod 755 /home/quentin/notes && \
    chown $USERNAME:$USERNAME /home/$USERNAME/notes.txt && chmod 400 /home/$USERNAME/notes.txt && \
    chown $USERNAME:$USERNAME /home/$USERNAME/notes && chmod +s /home/$USERNAME/notes && \
    echo "$APPUSER ALL=(ALL) NOPASSWD: /home/$USERNAME/notes" >> /etc/sudoers && \
    crontab -l | { cat; echo "* * * * * bash /opt/backup.sh"; } | crontab - 

EXPOSE 5555
EXPOSE 22

ENTRYPOINT ["/bin/sh", "-c", "/opt/entrypoint.sh"]